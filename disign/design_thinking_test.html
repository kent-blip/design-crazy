<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Design Thinking — 創造セッション 作成/練習ツール</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;color-scheme:dark}
    body{font-family:Inter, Roboto, system-ui, -apple-system; background:linear-gradient(180deg,#041021 0%, #071428 100%); color:#e6eef6; margin:0;padding:24px}
    .container{max-width:980px;margin:0 auto}
    h1{font-size:20px;margin:0 0 12px}
    .card{background:rgba(255,255,255,0.03);padding:16px;border-radius:12px;margin-bottom:16px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    label{display:block;margin-bottom:8px;font-size:13px;color:var(--muted)}
    select,input,textarea,button{font-size:14px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;width:100%}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .small{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:var(--accent);color:#021225;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .list{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:999px;font-size:13px}
    .timer{font-weight:700;font-size:18px;color:var(--accent)}
    .flex-between{display:flex;justify-content:space-between;align-items:center}
    .hidden{display:none}
    pre{white-space:pre-wrap;background:#031926;padding:12px;border-radius:8px;overflow:auto}
  </style>
</head>
<body>
  <h1>Who / Where / When 選択ツール</h1>

  <!-- 入力欄 -->
  <div>
    <label>Whoの候補（カンマ区切り）</label>
    <input id="whoChoices" value="大学生,会社員,主婦,子ども,観光客">
    <label>Whoの形容詞（カンマ区切り）</label>
    <input id="whoAdj" value="話好きな,疲れた,元気な,おしゃべりな,新しい">
  </div>

  <div>
    <label>Whereの候補</label>
    <input id="whereChoices" value="友人宅,ジム,公園,駅前,ショッピングモール">
    <label>Whereの形容詞</label>
    <input id="whereAdj" value="近所の,混雑した,静かな,広い,新しい">
  </div>

  <div>
    <label>Whenの候補</label>
    <input id="whenChoices" value="買い物しているとき,調べているとき,通勤中,旅行中,食事中">
    <label>Whenの形容詞</label>
    <input id="whenAdj" value="急いで,暇なとき,真夜中に,朝の,突然">
  </div>

  <button onclick="generateProblems()">ランダム生成</button>

  <!-- 出力欄 -->
  <div id="output"></div>

  <script>
    function generateProblems(){
      const whoBase = document.getElementById('whoChoices').value.split(',').map(s=>s.trim()).filter(Boolean)
      const whoAdj = document.getElementById('whoAdj').value.split(',').map(s=>s.trim()).filter(Boolean)
      const whereBase = document.getElementById('whereChoices').value.split(',').map(s=>s.trim()).filter(Boolean)
      const whereAdj = document.getElementById('whereAdj').value.split(',').map(s=>s.trim()).filter(Boolean)
      const whenBase = document.getElementById('whenChoices').value.split(',').map(s=>s.trim()).filter(Boolean)
      const whenAdj = document.getElementById('whenAdj').value.split(',').map(s=>s.trim()).filter(Boolean)

      let who = (whoAdj.length>0 ? whoAdj[Math.floor(Math.random()*whoAdj.length)] : '') 
              + (whoBase[Math.floor(Math.random()*whoBase.length)] || '')
      let where = (whereAdj.length>0 ? whereAdj[Math.floor(Math.random()*whereAdj.length)] : '') 
                + (whereBase[Math.floor(Math.random()*whereBase.length)] || '')
      let when = (whenAdj.length>0 ? whenAdj[Math.floor(Math.random()*whenAdj.length)] : '') 
               + (whenBase[Math.floor(Math.random()*whenBase.length)] || '')

      document.getElementById('output').innerHTML = `
        <p><b>Who:</b> ${who}</p>
        <p><b>Where:</b> ${where}</p>
        <p><b>When:</b> ${when}</p>
      `
    }
  </script>
</body>
</html>



    <div class="card" id="testControl">
      <div class="flex-between">
        <strong>テスト設定</strong>
        <div class="small">創造セッション: 制限時間30分（デフォルト）</div>
      </div>

      <div style="margin-top:12px">
        <label>問題数</label>
        <select id="numProblems"><option value="3">3</option><option value="4">4</option><option value="5" selected>5</option></select>

        <div style="margin-top:8px" class="row">
          <div class="col">
            <label>1問あたりの回答文字数制限（Why/What/How）</label>
            <input id="charLimit" value="50" />
          </div>
          <div class="col">
            <label>制限時間（分）</label>
            <input id="timeLimit" value="30" />
          </div>
        </div>

        <div style="margin-top:12px" class="actions">
          <button class="btn" id="generateBtn">問題を生成して開始</button>
          <button class="btn ghost" id="importBtn">サンプルをインポート</button>
        </div>
      </div>
    </div>

    <div class="card hidden" id="testPanel">
      <div class="flex-between">
        <strong>創造セッション 実施中</strong>
        <div><span class="timer" id="timer">00:00</span></div>
      </div>

      <div id="problemArea" style="margin-top:12px"></div>

      <div style="margin-top:12px" class="actions">
        <button class="btn" id="saveResponsesBtn">回答を保存</button>
        <button class="btn ghost" id="exportJsonBtn">JSONでエクスポート</button>
        <button class="btn ghost" id="exportCsvBtn">CSVでエクスポート</button>
        <button class="btn ghost" id="endTestBtn">終了</button>
      </div>
    </div>

    <div class="card">
      <strong>採点テンプレート（採点者用メモ）</strong>
      <div class="small" style="margin-top:8px">ニーズ発見力 (0-10), ソリューション創出力 (0-10) を問題ごとに記入し合算してください。</div>
      <pre id="gradingTemplate">問題,Who,Where,When,Why,What,How,NeedsScore,SolutionScore,Total
</pre>
    </div>

    <div class="card">
      <strong>開発者向け: Flaskバックエンド（オプション）</strong>
      <div class="small" style="margin-top:8px">以下はローカルで使う場合の簡単なFlaskサーバー例。保存・ロード・CSVダウンロードをサーバー側で処理できます。</div>
      <pre>
# app.py (Python 3.10+)
from flask import Flask, request, jsonify, send_file
from flask_cors import CORS
import json, csv, io
app = Flask(__name__)
CORS(app)

@app.route('/save', methods=['POST'])
def save():
    data = request.json
    # ここでは単純にファイルに保存
    with open('responses.json','w',encoding='utf-8') as f:
        json.dump(data,f,ensure_ascii=False,indent=2)
    return jsonify({'ok':True})

@app.route('/load', methods=['GET'])
def load():
    try:
        with open('responses.json','r',encoding='utf-8') as f:
            data = json.load(f)
    except FileNotFoundError:
        data = {}
    return jsonify(data)

@app.route('/download_csv')
def download_csv():
    # responses.json を csv に変換して返す例
    with open('responses.json','r',encoding='utf-8') as f:
        data = json.load(f)
    si = io.StringIO()
    cw = csv.writer(si)
    cw.writerow(['problem','who','where','when','why','what','how'])
    for p in data.get('problems',[]):
        cw.writerow([p.get(k,'') for k in ['id','who','where','when','why','what','how']])
    return si.getvalue(), 200, {'Content-Type':'text/csv; charset=utf-8'}

if __name__=='__main__':
    app.run(debug=True, port=5000)
      </pre>

      <div class="small" style="margin-top:8px">このHTML/JSはそのまま静的ホストで動きます。サーバー連携が必要なら above のエンドポイントへ fetch してください。</div>
    </div>

    <div style="height:40px"></div>
  </div>

  <script>
    // --- Utility: local storage keys ---
    const KEYWORDS_KEY = 'dt_keywords_v1'
    const RESPONSES_KEY = 'dt_responses_v1'

    // --- Elements ---
    const whoInput = document.getElementById('whoInput')
    const whereInput = document.getElementById('whereInput')
    const whenInput = document.getElementById('whenInput')
    const saveKeywordsBtn = document.getElementById('saveKeywordsBtn')
    const loadDefaultsBtn = document.getElementById('loadDefaultsBtn')
    const clearBtn = document.getElementById('clearBtn')
    const whoList = document.getElementById('whoList')
    const whereList = document.getElementById('whereList')
    const whenList = document.getElementById('whenList')

    const generateBtn = document.getElementById('generateBtn')
    const importBtn = document.getElementById('importBtn')
    const testPanel = document.getElementById('testPanel')
    const problemArea = document.getElementById('problemArea')
    const numProblemsEl = document.getElementById('numProblems')
    const charLimitEl = document.getElementById('charLimit')
    const timeLimitEl = document.getElementById('timeLimit')
    const timerEl = document.getElementById('timer')
    const saveResponsesBtn = document.getElementById('saveResponsesBtn')
    const exportJsonBtn = document.getElementById('exportJsonBtn')
    const exportCsvBtn = document.getElementById('exportCsvBtn')
    const endTestBtn = document.getElementById('endTestBtn')
    const gradingTemplate = document.getElementById('gradingTemplate')

    // --- State ---
    let keywords = {who:[], where:[], when:[]}
    let problems = []
    let responses = {problems: []}
    let timerInterval = null
    let timeLeftSec = 0

    // --- Helpers ---
    function saveKeywords(){
      const who = whoInput.value.split(',').map(s=>s.trim()).filter(Boolean)
      const where = whereInput.value.split(',').map(s=>s.trim()).filter(Boolean)
      const when = whenInput.value.split(',').map(s=>s.trim()).filter(Boolean)
      keywords = {who, where, when}
      localStorage.setItem(KEYWORDS_KEY, JSON.stringify(keywords))
      renderKeywordLists()
      alert('キーワードを保存しました')
    }

    function loadKeywords(){
      const raw = localStorage.getItem(KEYWORDS_KEY)
      if(raw){
        try{ keywords = JSON.parse(raw) }catch(e){keywords={who:[],where:[],when:[]}}
      }else{
        keywords = {who:['大学生','会社員','主婦','子ども','観光客'], where:['友人宅','ジム','公園','駅前','ショッピングモール'], when:['買い物しているとき','調べているとき','通勤中','旅行中','食事中']}
        localStorage.setItem(KEYWORDS_KEY, JSON.stringify(keywords))
      }
      whoInput.value = keywords.who.join(',')
      whereInput.value = keywords.where.join(',')
      whenInput.value = keywords.when.join(',')
      renderKeywordLists()
    }

    function renderKeywordLists(){
      whoList.innerHTML = ''
      whereList.innerHTML = ''
      whenList.innerHTML = ''
      keywords.who.forEach((w,i)=>{ const el = document.createElement('span'); el.className='chip'; el.textContent = (i+1)+'. '+w; whoList.appendChild(el) })
      keywords.where.forEach((w,i)=>{ const el = document.createElement('span'); el.className='chip'; el.textContent = (i+1)+'. '+w; whereList.appendChild(el) })
      keywords.when.forEach((w,i)=>{ const el = document.createElement('span'); el.className='chip'; el.textContent = (i+1)+'. '+w; whenList.appendChild(el) })
    }

    function clearKeywords(){
      if(confirm('キーワードをクリアしますか？')){
        keywords = {who:[],where:[],when:[]}
        localStorage.removeItem(KEYWORDS_KEY)
        whoInput.value = ''
        whereInput.value = ''
        whenInput.value = ''
        renderKeywordLists()
      }
    }

    // --- Problem generation ---
    function generateProblems(){
      const n = parseInt(numProblemsEl.value,10)
      if(keywords.who.length<1 || keywords.where.length<1 || keywords.when.length<1){ alert('Who/Where/When をそれぞれ1つ以上入力してください') ; return }
      problems = []
      for(let i=0;i<n;i++){
        const whoIdx = Math.floor(Math.random()*keywords.who.length)
        const whereIdx = Math.floor(Math.random()*keywords.where.length)
        const whenIdx = Math.floor(Math.random()*keywords.when.length)
        problems.push({id:i+1, whoIdx, whereIdx, whenIdx, who:keywords.who[whoIdx], where:keywords.where[whereIdx], when:keywords.when[whenIdx], why:'', what:'', how:''})
      }
      responses = {problems: problems.map(p=>({...p}))}
      renderProblems()
      startTimer()
      testPanel.classList.remove('hidden')
    }

    function renderProblems(){
      problemArea.innerHTML = ''
      const limit = parseInt(charLimitEl.value || '50',10)
      problems.forEach((p,pi)=>{
        const wrapper = document.createElement('div')
        wrapper.style.marginBottom='12px'
        wrapper.innerHTML = `
          <div style="font-weight:700">問題 ${p.id}</div>
          <div class="small" style="margin:6px 0">Who: ${p.who} &nbsp; | &nbsp; Where: ${p.where} &nbsp; | &nbsp; When: ${p.when}</div>
          <label>Why（50字以内）</label>
          <textarea data-prob="${pi}" data-field="why" rows="2" maxlength="${limit}"></textarea>
          <div class="small">残り: <span class="remain">${limit}</span> 文字</div>
          <label style="margin-top:8px">What（技術、50字以内）</label>
          <textarea data-prob="${pi}" data-field="what" rows="2" maxlength="${limit}"></textarea>
          <div class="small">残り: <span class="remain">${limit}</span> 文字</div>
          <label style="margin-top:8px">How（方法、50字以内）</label>
          <textarea data-prob="${pi}" data-field="how" rows="2" maxlength="${limit}"></textarea>
          <div class="small">残り: <span class="remain">${limit}</span> 文字</div>
        `
        problemArea.appendChild(wrapper)
      })

      // attach listeners for remaining count
      problemArea.querySelectorAll('textarea').forEach(ta=>{
        const span = ta.parentElement.querySelector('.remain')
        ta.addEventListener('input', e=>{ const rem = ta.maxLength - ta.value.length; span.textContent = rem })
      })
    }

    // --- Timer ---
    function startTimer(){
      const minutes = parseInt(timeLimitEl.value || '30',10)
      timeLeftSec = minutes*60
      updateTimerDisplay()
      if(timerInterval) clearInterval(timerInterval)
      timerInterval = setInterval(()=>{
        timeLeftSec -=1
        if(timeLeftSec<=0){ clearInterval(timerInterval); alert('時間終了です。自動で保存します。'); saveResponses(); }
        updateTimerDisplay()
      },1000)
    }
    function updateTimerDisplay(){
      const m = Math.floor(timeLeftSec/60).toString().padStart(2,'0')
      const s = (timeLeftSec%60).toString().padStart(2,'0')
      timerEl.textContent = `${m}:${s}`
    }

    // --- Save / Export ---
    function collectResponses(){
      const taList = problemArea.querySelectorAll('textarea')
      taList.forEach(ta=>{
        const pi = parseInt(ta.dataset.prob,10)
        const field = ta.dataset.field
        responses.problems[pi][field] = ta.value.trim()
      })
      // update grading template for convenience
      let csv = '問題,Who,Where,When,Why,What,How,NeedsScore,SolutionScore,Total'
      responses.problems.forEach(p=>{
        csv += `${p.id},"${p.who}","${p.where}","${p.when}","${(p.why||'').replace(/"/g,'"')}","${(p.what||'').replace(/"/g,'"')}","${(p.how||'').replace(/"/g,'"')}",,,
`
      })
      gradingTemplate.textContent = csv
    }

    function saveResponses(){
      collectResponses()
      localStorage.setItem(RESPONSES_KEY, JSON.stringify(responses))
      alert('回答を保存しました（ローカル）')
    }

    function exportJson(){
      collectResponses()
      const dataStr = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(responses, null, 2))
      const a = document.createElement('a'); a.href = dataStr; a.download = 'dt_responses.json'; a.click()
    }

    function exportCsv(){
      collectResponses()
      let csv = '問題,Who,Where,When,Why,What,How'
      responses.problems.forEach(p=>{
        const row = [p.id, p.who, p.where, p.when, p.why, p.what, p.how].map(v=>`"${(v||'').replace(/"/g,'"')}"`).join(',')
        csv += row + ''
      })
      const dataStr = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv)
      const a = document.createElement('a'); a.href = dataStr; a.download = 'dt_responses.csv'; a.click()
    }

    // --- Import sample to test ---
    function importSample(){
      const sample = {who:['高齢者','学生','ビジネスパーソン','子育て中の親','観光客'], where:['自宅','公園','病院','電車内','ショッピングモール'], when:['大雨の日','旅行中','朝の通勤時間','休日の午後','運動不足を感じた時']}
      keywords = sample
      localStorage.setItem(KEYWORDS_KEY, JSON.stringify(keywords))
      loadKeywords()
      alert('サンプルキーワードを読み込みました')
    }

    // --- Event bindings ---
    saveKeywordsBtn.addEventListener('click', saveKeywords)
    loadDefaultsBtn.addEventListener('click', loadKeywords)
    clearBtn.addEventListener('click', clearKeywords)
    generateBtn.addEventListener('click', generateProblems)
    importBtn.addEventListener('click', importSample)
    saveResponsesBtn.addEventListener('click', saveResponses)
    exportJsonBtn.addEventListener('click', exportJson)
    exportCsvBtn.addEventListener('click', exportCsv)
    endTestBtn.addEventListener('click', ()=>{ if(confirm('テストを終了しますか？')){ if(timerInterval) clearInterval(timerInterval); collectResponses(); localStorage.setItem(RESPONSES_KEY, JSON.stringify(responses)); testPanel.classList.add('hidden') } })

    // init
    loadKeywords()
    const saved = localStorage.getItem(RESPONSES_KEY)
    if(saved){ try{ responses = JSON.parse(saved) }catch(e){ responses={problems:[]} } }
  </script>
</body>
</html>
